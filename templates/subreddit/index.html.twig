{% extends 'base.html.twig' %}

{% block title %}{{ post.title }} - Reddit{% endblock %}

{% block body %}
    <h1>{{ post.title }}</h1>
    <p>by {{ post.author.username }} in <a href="{{ path('subreddit_show', {'id': post.subreddit.id}) }}">r/{{ post.subreddit.name }}</a></p>
    <p>{{ post.content|raw }}</p>

    {% if app.user and (post.author == app.user or is_granted('ROLE_ADMIN')) %}
        <a href="{{ path('post_edit', {'id': post.id}) }}" class="btn btn-secondary btn-sm">Edit</a>
        <form method="post" action="{{ path('post_delete', {'id': post.id}) }}" style="display: inline" onsubmit="return confirm('Are you sure?');">
            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ post.id) }}">
            <button class="btn btn-danger btn-sm">Delete</button>
        </form>
    {% endif %}

    <hr />

    <h3>Comments</h3>
    {% if post.comments|length == 0 %}
        <p>No comments yet.</p>
    {% else %}
        {% for comment in post.comments %}
            <div class="mb-3 border p-2 rounded">
                <p><strong>{{ comment.author.username }}</strong> said:</p>
                <p>{{ comment.content|raw }}</p>
                {% if comment.fileName %}
                    <p>Attachment: <a href="{{ asset('uploads/comments/' ~ comment.fileName) }}" target="_blank">View</a></p>
                {% endif %}
                <small>Posted {{ comment.createdAt|date('Y-m-d H:i') }}</small>

                {% if app.user and (comment.author == app.user or is_granted('ROLE_ADMIN')) %}
                    <form method="post" action="{{ path('comment_delete', {'id': comment.id}) }}" onsubmit="return confirm('Delete this comment?');" class="mt-2">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comment.id) }}">
                        <button class="btn btn-danger btn-sm">Delete</button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
    {% endif %}

    {% if app.user and app.user.isConfirmed %}
        <hr/>
        <h4>Add a Comment</h4>
        {{ form_start(commentForm, {'attr': {'enctype': 'multipart/form-data'}}) }}
        {{ form_row(commentForm.content) }}
        {{ form_row(commentForm.file) }}
        <button type="submit" class="btn btn-primary">Submit</button>
        {{ form_end(commentForm) }}
    {% else %}
        <p><em>Please confirm your registration to comment.</em></p>
    {% endif %}
{% endblock %}
